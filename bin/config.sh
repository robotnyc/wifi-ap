#!/bin/bash
#
# Copyright (C) 2015, 2016 Canonical Ltd
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License version 3 as
# published by the Free Software Foundation.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program.  If not, see <http://www.gnu.org/licenses/>.

. $SNAP/bin/config-internal.sh

set_item() {
	case $1 in
		disabled)
			DISABLED=$2
			;;
		debug)
			DEBUG=$2
			;;
		wifi-interface)
			WIFI_INTERFACE=$2
			;;
		wifi-address)
			WIFI_ADDRESS=$2
			;;
		wifi-interface-mode)
			WIFI_INTERFACE_MODE=$2
			;;
		wifi-hostapd-driver)
			WIFI_HOSTAPD_DRIVER=$2
			;;
		wifi-ssid)
			WIFI_SSID=$2
			;;
		wifi-security)
			WIFI_SECURITY=$2
			;;
		wifi-security-passphrase)
			WIFI_SECURITY_PASSPHRASE=$2
			;;
		wifi-channel)
			WIFI_CHANNEL=$2
			;;
		wifi-operation-mode)
			WIFI_OPERATION_MODE=$2
			;;
		ethernet-interface)
			ETHERNET_INTERFACE=$2
			;;
		dhcp-range-start)
			DHCP_RANGE_START=$2
			;;
		dhcp-range-stop)
			DHCP_RANGE_STOP=$2
			;;
		dhcp-lease-time)
			DHCP_LEASE_TIME=$2
			;;
		*)
			echo "Unknown config item '$1'"
			exit 1
	esac
}

dump_config() {
	echo "DISABLED=$DISABLED"
	echo "DEBUG=$DEBUG"
	echo "WIFI_INTERFACE=$WIFI_INTERFACE"
	echo "WIFI_ADDRESS=$WIFI_ADDRESS"
	echo "WIFI_INTERFACE_MODE=$WIFI_INTERFACE_MODE"
	echo "WIFI_HOSTAPD_DRIVER=$WIFI_HOSTAPD_DRIVER"
	echo "WIFI_SSID=$WIFI_SSID"
	echo "WIFI_SECURITY=$WIFI_SECURITY"
	echo "WIFI_SECURITY_PASSPHRASE=$WIFI_SECURITY_PASSPHRASE"
	echo "WIFI_CHANNEL=$WIFI_CHANNEL"
	echo "WIFI_OPERATION_MODE=$WIFI_OPERATION_MODE"
	echo "ETHERNET_INTERFACE=$ETHERNET_INTERFACE"
	echo "DHCP_RANGE_START=$DHCP_RANGE_START"
	echo "DHCP_RANGE_STOP=$DHCP_RANGE_STOP"
	echo "DHCP_LEASE_TIME=$DHCP_LEASE_TIME"
}

write_configuration() {
	config_data=$(dump_config)
	cat <<-EOF > $SNAP_DATA/config
	#!/bin/bash
	# THIS FILE IS AUTOGENERATED. Please use the the wifi-ap.config
	# command to change the configuration or create a overlay
	# configuration file at $SNAP_USER_DATA/config
	$config_data
	EOF
}

case "$1" in
	set)
		shift
		key=$1
		shift
		value=$1
		shift
		set_item $key $value
		write_configuration
		;;
	dump)
		dump_config
		shift
		;;
	*)
		echo "Unknown command '$1'."
		exit 1
		;;
esac
