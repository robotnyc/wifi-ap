summary: Verify that the default configuration is able to spawn up an AP

prepare: |
    # Simulate two WiFi radio network interfaces
    modprobe mac80211_hwsim radios=2

restore: |
    rmmod mac80211_hwsim

execute: |
    . $TESTSLIB/utilities.sh

    # Default configuration will use wlan0 which we just created
    /snap/bin/wifi-ap.config set disabled 0

    systemctl restart snap.wifi-ap.backend
    wait_for_systemd_service snap.wifi-ap.backend

    snap install wireless-tools
    snap connect wireless-tools:network-control core

    # Scan for existing WiFi networks and ensure our 'Ubuntu' one is part
    # of the result
    ifconfig wlan1 up
    /snap/bin/wireless-tools.iw dev wlan1 scan | grep 'SSID: Ubuntu'
    /snap/bin/wireless-tools.iw dev wlan1 scan | grep 'primary channel: 6'
    # There should be only a single network
    network_count=`/snap/bin/wireless-tools.iw dev wlan1 scan | grep -c 'SSID: Ubuntu'`
    test $network_count -eq 1
    # The AP should not be secured by default
    ! /snap/bin/wireless-tools.iw dev wlan1 scan | grep 'WPA:'
    ! /snap/bin/wireless-tools.iw dev wlan1 scan | grep 'RSN:'

    # Verify we can associate with the AP
    /snap/bin/wireless-tools.iw wlan1 connect Ubuntu
    /snap/bin/wireless-tools.iw dev wlan1 link | grep 'SSID: Ubuntu'

    # And we should get an IP address assigned over DHCP
    dhclient wlan1
    # IP Address and routing needs to be correct
    ifconfig wlan1 | fgrep 'inet addr:10.0.60.1'
    ip route | fgrep '10.0.60.0/24 dev wlan1'
    ip route | fgrep 'default via 10.0.60.1 dev wlan1'
